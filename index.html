<!DOCTYPE html>

<head>
	<meta charset="utf-8" />
	<title>Esprima</title>

	<script src="jquery-1.9.1.js"></script>
	<script src="esprima.js"></script>
	<script src="escodegen.browser.js"></script>
	<script src="esmorph.js"></script>

	<script type="text/javascript" src="FAMIX.js"></script>

	<style type="text/css">
		textarea{
			width: 500px;
			height: 300px;
		}
		.inline{
			display: inline-block;
		}
	</style>
</head>

<body>

	<h1>Esprima</h1>

	<div class="inline">
		<textarea id="input">
var console = console || {};

var Shape = function Shape(x,y){
	var x = x
	   ,y = y;

	this.getX = function getX(){
		return x;
	};

	this.getY = function getY(){
		return y;
	};

	this.setX = function setX(n_x){
		x = n_x;
	};

	this.setY = function setY(n_y){
		y = n_y;
	};
}

var gX = function getX(){
   return 3;
};
function aFunction(x,y){
	return new Shape(x,y);
}

var s = new Shape(1,2);

sha = new Shape(3,4);

console.log(s.getX());

var functionA = function functionA(){
	var some = 4
	return 4 + some;
};

var functionB = function functionB(){
	return functionA();
};

var anon = function(){
	var a = functionB();
	return functionA() + a;
}

var functionC = function functionC(){
	return s.getX();
}
		</textarea>
	</div>
	
	<button id="parse">Parse!</button>
	<button id="getmse">getMSE</button>

	<div class="inline">
		<div id="tree">

		</div>

		<div>
			<code id="output">

			</code>
		</div>



		<h2>Summary</h2>
		<ul id="function_names">

		</ul>

		<textarea id="mse_content"></textarea>
	</div>

	
	

	<script type="text/javascript">

	var functions = [];

	var collect = function collect(obj, predicate){
		var list = [];
		if(typeof obj === 'object'){
			if(predicate(obj)){
				list.push(obj);
			}
			for(var key in obj){
				var value = obj[key];
				var other_list = collect(value, predicate);
				list = list.concat(other_list);
			}
		} 
		return list;
	};

	var pred_is_a = function pred_is_a(obj, typeName){
		if(obj === null || obj.type === undefined){
			return false;
		} else if(obj.type === typeName){
			return true;
		} else {
			return false;
		}
	}

	var pred_IsFunctionExpression = function pred_IsFunctionExpression(obj){
		return pred_is_a(obj,'FunctionExpression');
	};

	var pred_IsFunctionDeclaration = function pred_IsFunctionDeclaration(obj){
		return pred_is_a(obj,'FunctionDeclaration');
	};

	var pred_IsFunction = function pred_IsFunction(obj){
		return pred_IsFunctionDeclaration(obj) || pred_IsFunctionExpression(obj);
	}

	var pred_IsCallExpression = function pred_IsCallExpression(obj){
		return pred_is_a(obj,'CallExpression');
	};

	var pred_IsIfStatement = function pred_IsIfStatement(obj){
		return pred_is_a(obj,'IfStatement');
	};

	var pred_IsMemberCallExpression = function pred_IsMemberCallExpression(obj){
		return pred_is_a(obj,'CallExpression') && pred_is_a(obj.callee, 'MemberExpression');
	}

	var pred_isVariableDeclarator = function pred_isVariableDeclarator(obj){
		return pred_is_a(obj,'VariableDeclarator');
	}

	var pred_isVariableDeclaration = function pred_isVariableDeclaration(obj){
		return pred_is_a(obj,'VariableDeclaration');
	}

	var pred_isVariableDeclarator = function pred_isVariableDeclarator(obj){
		return pred_is_a(obj,'VariableDeclarator');
	}

	/*var getFunctions = function getFunctions(AST){
		return collect(AST, pred_IsFunction);
	}*/

	/*var getFunctionCalls = function getFunctionCalls(functionAST){
		return collect(functionAST, pred_IsCallExpression);
	}*/

	/*var getVariableDeclaration = function getVariableDeclaration(AST){
		return collect(AST, pred_isVariableDeclaration);
	}*/

	/*var getVariableDeclarator = function getVariableDeclarator(AST){
		// console.log(AST);
		return collect(AST, pred_isVariableDeclarator);
	}*/

	var getMemberCall = function getMemberCall(functionAST){
		var getCallee = function getCallee(o){
			return o.callee;
		};
		return map(collect(functionAST, pred_IsMemberCallExpression), getCallee);
	}

	/**
	* Each VariableDeclaration can have more than one declaration separated by comma so a pickup must be made
	**/
	/*var getVarDeclarations = function getVarDeclarations(AST){
		var variable_declarations = [];
		// Obtain the corresponding AST nodes
		var arr = getVariableDeclaration(AST);
		// Pickup each declaration
		$.each(arr, function(index,el){
			variable_declarations = variable_declarations.concat(el.declarations);
		});
		return variable_declarations;

	}*/


	/**
		function for getting a function sender, if none window is assumed
	**/
	var getSender = function getSender(AST, functionAST){

		var does_call_funcionAST = function does_call_funcionAST(element){
			var body = element.body;
			for(var line in body){
				var statement = body[line];
				var collection = collect(statement, function(e){
					return e == functionAST;
				});
				if(collection.length > 0){
					return true;
				}
				// console.log(collection);
			}
			return false;
		}
		var res = functions.filter(does_call_funcionAST);
		// console.log(res);
		if(res.length != 0){
			return res[res.length-1];
		} else{
			return {id:{name:'window'}};
		} 
	}

	var f_functions = [];
	var f_global_variables = [];
	var f_invocations = [];

	f_functions.push(famix_window);

	var new_collect = function new_collect(AST, context){
		var obj = AST;
		if(typeof AST === 'object'){
			for(var key in obj){
				var value = obj[key];
				if(pred_IsFunction(value)){
					// Fix for anonymous functions
					var name = "$"+value.loc.start.line+"_"+value.loc.start.column;
					if(value.id != null){
						name = value.id.name;
					}
					var f = new FAMIX_FUNCTION(name);
					f.context = context;
					f.LOC = value.range[1] - value.range[0] + 1;
					f.statements = value.body.body.length;
					f.params = value.params.map(function(e){
						return e.name;
					});
					f_functions.push(f);

					// If a local function declaration is made, it must be added to the context static_scope_functions
					if(pred_IsFunctionDeclaration(value)){
						context.static_scope_functions[f.name] = f;
					}
					// Static scope variables is inherited
					f.static_scope_variables = context.static_scope_variables;

					// Statis scope functions is inherited
					f.static_scope_functions = context.static_scope_functions;

					new_collect(value,f);

				} else if (pred_IsCallExpression(value)){
					var f = new FAMIX_INVOCATION();
					f.candidates = [];
					f.sender = context;
					// It's like an object message call
					if(value.callee.type == 'MemberExpression'){
						f.signature = value.callee.property.name;
						f.receiver = context.static_scope_variables[value.callee.object.name];
					// This is just a simple function call	
					} else if (value.callee.type == 'Identifier'){
						f.signature = value.callee.name;
						f.receiver = context;
					} else if(value.callee.type == 'FunctionExpression'){

					} else if(value.callee.type == 'NewExpression'){

					} else if(value.callee.type == 'LogicalExpression'){

					} else if(value.callee.type == 'ConditionalExpression'){

					} else {
						// console.log(value);
						//throw "value.callee.type unknown " +value.loc.start.line + ":" + value.loc.start.column + " " + value.callee.type;
					}
					if(typeof f.signature == 'undefined'){
						f.signature = value.callee.object.name;
					}
					// In some cases the function map appears as a receiver
					if( typeof f.signature != 'undefined' && typeof f.receiver != 'undefined' && typeof f.receiver != 'function'){
						f_invocations.push(f);
					}
					new_collect(value,context);

				} else if (pred_isVariableDeclaration(value)){
					new_collect(value,context);
				} else if (pred_isVariableDeclarator(value)){
					var f = new FAMIX_GLOBAL_VAR(value.id.name);
					if(value.id.name != 'length'){
						context.static_scope_variables[value.id.name] = f
					} else {
						context.static_scope_variables['$length'] = f
					}
					
					f_global_variables.push(f);
					new_collect(value,context);
				} else {
					new_collect(value,context);
				}
			}
		} 
		return;
	}

	var new_candidates = function new_candidates(invocations, functions){
		return invocations.map(function(invocation){
			var candidates = functions.filter(function(fun){
				return fun.name == invocation.signature;
			});
			invocation.candidates = candidates;
			return invocation;
		});
	}

	// This functions returns the MSE text for some JavasScript code
	var getMSE = function getMSE(js_code){
		t = esprima.parse(js_code, {range:true, loc:true});
		new_collect(t,famix_window);
		new_candidates(f_invocations, f_functions);
		var str = "(\n";
		f_functions.map(function(e){
			str += e.toString(1);
		});	
		f_invocations.map(function(e){
			str += e.toString(1);
		});	
		f_global_variables.map(function(e){
			str += e.toString(1);
		});	
		str += ')';
		return str;
	}

	$(document).ready(function(){

		$('#getmse').click(function(){
			var code = $('#input').val().trim();
			$('#mse_content').html(getMSE(code));
		});
		
	});
	
	</script>

</body>
</html>
